name: Submissions via Issues
on:
  issue_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number

jobs:
  approval:
    # this job only runs for issue comments or manual dispatch
    name: Check if submission is approved
    runs-on: ubuntu-latest
    if: ${{ github.event.issue.number || github.event.inputs.issue_number }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
      - name: Check if authorized member has approved submission
        run: ruby ${GITHUB_WORKSPACE}/.github/helper/approval.rb
        env:
            ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  contribution:
    name: Extract, Commit & Push submission to default branch
    runs-on: ubuntu-latest
    needs: approval
    steps:
      - uses: actions/checkout@v4
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'

      - name: Fetch issue body
        id: issue
        run: |
          ISSUE_NUM=${{ github.event.issue.number || github.event.inputs.issue_number }}
          ISSUE_BODY=$(gh issue view $ISSUE_NUM --json body --jq '.body')
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        with:
          template-path: .github/ISSUE_TEMPLATE/new_submission.yml
          issue-body: ${{ steps.issue.outputs.body }}

      - name: Update submissions file
        run: ruby ${GITHUB_WORKSPACE}/.github/helper/update.rb
        env:
          submission_entry: ${{ steps.issue-parser.outputs.jsonString }}

      - name: Record Sorter
        run: ruby ${GITHUB_WORKSPACE}/.github/helper/record_sorter.rb

      - name: Commit + Push changes
        uses: EndBug/add-and-commit@v9
        with:
          message: |
            docs: Add ${{ fromJson(steps.issue-parser.outputs.jsonString).app_or_resource_name }}

            Closes #${{ github.event.issue.number || github.event.inputs.issue_number }}

  cleanup:
    name: Close Issue thread after successful contribution
    runs-on: ubuntu-latest
    needs: contribution
    steps:
      - name: Close Issue
        uses: peter-evans/close-issue@v3
        with:
          issue-number: ${{ github.event.issue.number || github.event.inputs.issue_number }}
          comment: |
            Thanks for your contribution! :tada:

            Your submission has been successfully added to the awesome-frappe list and is now live on the website.

            The changes have been committed to the main branch.
